var Edge=function(){"use strict";var i=function(i,t,r){this.parent=i,this.child=t,this.typeRelationship=r,this.init()};return i.prototype={calcCoordinates:function(){this.methodOfType[this.typeRelationship].calculation()},render:function(i){return this.drawAndSetEdgeContainer(i),this.calcCoordinates(),this.methodOfType[this.typeRelationship].render(),this.container},drawAndSetEdgeContainer:function(i){this.container=i.append("g").attr("class",this.options.class)},init:function(){var i=this;this.methodOfType={marriage:{calculation:function(){return i.calcCoorTypeMarrige()},render:function(){return i.renderTypeMarrige()}},of_marriage:{calculation:function(){return i.calcCoorTypeOfMarrige()},render:function(){return i.renderTypeOfMarrige()}}},this.createOptions()},createOptions:function(i){var t={"class":"link",strokeColor:"black",strokeWidth:1};this.options=$.extend(!0,t,i)},calcCoorTypeMarrige:function(){var i=[],t=this.child.width/2+4,r=this.child.height/2+1,s={x:this.parent.x+t,y:this.parent.y+r};i.push(s),t=this.child.width/4,s={x:this.child.x+t,y:this.child.y+r},i.push(s),t=this.child.width/2+4,r=this.child.height/2+4,s={x:this.parent.x+t,y:this.parent.y+r},i.push(s),t=this.child.width/4,s={x:this.child.x+t,y:this.child.y+r},i.push(s);var e=i[1].x+(i[0].x-i[1].x)/2;s={x:e,y:this.parent.y+r},this.parent===this.child&&(s.y=this.parent.y+this.parent.height-3),i.push(s),r+=25,s={x:e,y:this.child.y+r},i.push(s),this.coordinates={pairs:i,middle:e}},calcCoorTypeOfMarrige:function(){var i=[],t=-3,r=this.child.x+this.child.width/2,s=this.child.y+this.child.height/2,e={x:r,y:s+t};i.push(e),t=-7,e={x:r,y:s+t},i.push(e),t=-6.5,e={x:r,y:s+t},i.push(e),e=_.last(this.parent.coordinates.pairs),i.push(e),this.coordinates={pairs:i}},renderTypeMarrige:function(){this.parent!==this.child&&(this.drawLink(this.coordinates.pairs.slice(0,2)),this.drawLink(this.coordinates.pairs.slice(2,4))),this.drawLink(this.coordinates.pairs.slice(4,6))},renderTypeOfMarrige:function(){this.drawLink(this.coordinates.pairs.slice(0,2)),this.drawLink(this.coordinates.pairs.slice(2,4))},drawLink:function(i){this.container.append("line").attr("x1",i[0].x).attr("y1",i[0].y).attr("x2",i[1].x).attr("y2",i[1].y).attr("stroke-width",this.options.strokeWidth).attr("stroke",this.options.strokeColor)},setColor:function(i){this.container.selectAll("line").style("stroke",i)}},i}();
var GenealogyTree=function(t,e,n){this.init(),this.nodes=this.createNodes(t),this.relationships=e,this.dataLayouts[this.level]=n};GenealogyTree.prototype={init:function(){this.level=0,this.dataLayouts=[],this.layouts=[],this.edges=[],this.buildGenealogyPathFromAdam=this.partial(this.buildGenealogyPath,this.getAdamNode,this)},generation:function(){this.generationLayouts(),this.gtClal=new GenealogyTreeCalculator(this.layouts,this.edges),this.gtClal.calcContainerParameters(),this.gtClal.calcCoordinatesForLayouts()},getContainerParameters:function(){var t={width:this.gtClal.options.container.width,height:this.gtClal.options.container.height};return t},generationLayouts:function(){for(;;){this.preparationLayout();var t=this.dataLayouts[this.level];if(this.generationLayout(t),!this.needToCreateNextLayout())break;this.level++}},generationLayout:function(t){_.each(t.relationships,this.preparationRelationship,this),this.addNodesForLayout(t.nodes,this.layouts,this.level)},preparationLayout:function(){var t=this.dataLayouts[this.level];this.dataLayouts[this.level]=this.getRelationshipsAndNodes(t)},needToCreateNextLayout:function(){return this.nextLayoutIsExists()},nextLayoutIsExists:function(){var t=this.level+1;return this.dataLayouts[t]&&0!==this.dataLayouts[t].length?!0:!1},preparationRelationship:function(t){this.addSpousesNodeToLayout(t),this.addNodesForLayout(t.children,this.dataLayouts,this.level+1),this.createEdges(t),this.unsetRelationship(t)},addSpousesNodeToLayout:function(t){var e=this.findNodesByIds(t.spouses);this.addNodesForLayout(e,this.layouts,this.level)},addNodesForLayout:function(t,e,n){var s=e[n];s||(s=[]),s=s.concat(t),e[n]=s},getRelationshipsAndNodes:function(t){var e=[];_.each(this.relationships,function(n){for(var s=0;s<n.spouses.length;s++){var i=n.spouses[s];_.contains(t,i)&&(e.push(n),t=_.without(t,i))}});var n={relationships:_.uniq(e),nodes:this.findNodesByIds(t)};return n},findNodesByIds:function(t){var e=[];return _.each(t,function(t){var n=_.findWhere(this.nodes,{id:t});e.push(n)},this),e},createEdges:function(t){var e=[],n=this.findNodesByIds(t.spouses),s=new Edge(_.first(n),_.last(n),t.type);e.push(s);var i=this.findNodesByIds(t.children);_.each(i,function(i){var a=new Edge(s,i,t.childrenType);e.push(a),i.updateToChildNode(n,a)},this),this.edges=this.edges.concat(e),_.first(n).updateToParentNode(i,e),_.last(n).updateToParentNode(i,e)},unsetRelationship:function(t){var e=this,n=_.find(this.relationships,function(n){e.comparison(n,t)});return this.relationships.splice(n,1)},getNodes:function(){var t=_.flatten(this.layouts);return t},comparison:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},createNodes:function(t){var e=[];return _.each(t,function(t){var n=new Node(t);e.push(n)}),e},render:function(t){this.svgContainer=t,this.renderEdges(),this.renderNodes()},renderNodes:function(){this.renderNodeContainers(),this.renderNodeImgs(),this.renderNodelabels(),this.renderSymbols()},renderNodeContainers:function(){this.svgNodes=this.svgContainer.selectAll(".node").data(this.nodes).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"})},renderNodeImgs:function(){this.svgNodes.append("svg:image").attr("class","img").attr("xlink:href",function(t){var e="img/"+t.gender+".png";return e}).attr("width",function(t){return t.width}).attr("height",function(t){return t.height}).attr("y",function(t){return"female"===t.gender?4.5:void 0}).attr("x",function(t){return"female"===t.gender?-.5:void 0})},partial:function(t,e,n){return function(s){return t(s,e(),n)}},getAdamNode:function(){var t="Adam",e=_.findWhere(this.nodes,{name:t});return e},buildGenealogyPath:function(t,e,n){n.deactivatePath(),n.buildPartOfGenealogyPath(t,e)},isEndBuildGenealogyPath:function(t,e){return t===e?!0:0===t.parents.length?!0:!1},buildPartOfGenealogyPath:function(t,e){if(!this.isEndBuildGenealogyPath(t,e)){var n="#FF0000",s=_.first(t.parents),i=_.findWhere(this.edges,{parent:s});i.setColor(n);var a=_.findWhere(this.edges,{child:t});a.setColor(n),this.buildPartOfGenealogyPath(s,e)}},deactivatePath:function(){_.each(this.edges,function(t){t.setColor()})},renderNodelabels:function(){this.svgNodes.append("text").attr("class","label").attr("y",30).text(function(t){return t.name})},renderSymbols:function(){this.svgNodes.filter(function(t){return t.whetherDrawSymbol()}).append("text").attr("class","symbol").attr("dx",function(t){return t.symbol.x}).attr("y",function(t){return t.symbol.y}).text(function(t){return t.symbol.text})},renderEdges:function(){this.svgEdges=[],_.each(this.edges,function(t){var e=t.render(this.svgContainer);this.svgEdges.push(e)},this)}};
var GenealogyTreeCalculator=function(t,i){"use strict";this.layouts=t,this.edges=i,this.options=this.getDefaultOptions(),this.level=0};GenealogyTreeCalculator.prototype={getDefaultOptions:function(){var t={frame:{width:250,height:250},stepX:50,stepY:50,nodeWidth:30};return t},calcCoordinatesForLayouts:function(){for(var t=0;t<this.layouts.length;t++){var i=this.layouts[t],o=_.sortBy(i,this.sort);this.layouts[t]=this.calcCoordinatesForLayout(o),this.level++}},sort:function(t){return-1*t.weight},calcCoordinatesForLayout:function(t){var i=[],o=this.calcValX(t.length),n=this.calcValY();return _.each(t,function(t){t.x=o,t.y=n,i.push(t),o+=this.options.stepX},this),i},calcContainerParameters:function(){this.options.container={width:this.calcWidth小ontainer(),height:this.calcHeight小ontainer()}},widthCalculationLayout:function(){if(this.layouts.length<=0)return 0;var t=[];if(_.each(this.layouts,function(i){if(i){var o=i.length;t.push(o)}}),t.length<=0)return 0;var i=_.max(t,function(t){return t}),o=this.options.nodeWidth*i+(i-1)*this.options.stepY;return o},"calcWidth小ontainer":function(){var t=this.widthCalculationLayout(),i=2*this.options.frame.width,o=t+i;return o},"calcHeight小ontainer":function(){var t=this.layouts.length*this.options.stepY,i=2*this.options.frame.height,o=t+i;return o},calcValY:function(){var t=this.options.frame.height,i=this.level*this.options.stepY,o=t+i;return o},calcValX:function(t){var i=(t/2*this.options.nodeWidth+(t-1)*this.options.stepX)/2,o=this.options.container.width/2-i;return o}};
var Node=function(t){this.id=t.id,this.name=t.name,this.gender=t.gender,this.isConcubine=t.isConcubine,this.isUnnamed=t.isUnnamed,this.isDeid=t.isDeid,this.weight=t.weight,this.width=this.getWidth(),this.height=this.getHeight(),this.parents=[],this.children=[],this.edges=[],this.symbol=this.getSymbol(),this.type="Node"};Node.prototype={getType:function(){return this.type},updateToParentNode:function(t,i){this.children=t,this.edges=i},updateToChildNode:function(t,i){this.parents=t,this.edges=this.edges.concat(i)},getWidth:function(){var t=20;return this.width||(this.width=t),this.width},getHeight:function(){var t=20;return this.height||(this.height=t),this.height},getSymbol:function(){var t={concubine:{text:"c",x:6.2,y:14.8},unnamed:{text:"?",x:6.7,y:15.6}};for(var i in this){var e=i.substr(2,i.length).toLowerCase();if(t[e]&&this[i])return t[e]}},whetherDrawSymbol:function(){var t=this.isConcubine||this.isUnnamed;return t}};
var Render=function(t){this.options=$.extend(!0,this.getDefaultOptions(),t),this.createContainer()};Render.prototype={getDefaultOptions:function(){var t={container:{id:"#tree",width:1e3,height:1e3},zoom:[.7,3],focus:{scale:2}};return t},createContainer:function(){this.svg=d3.select(this.options.container.id).append("svg").attr("width",this.options.container.width).attr("height",this.options.container.height);var t=d3.behavior.zoom().scaleExtent(this.options.zoom).on("zoom",this.zoom());this.wrapper=this.svg.append("g").call(t),this.main=this.wrapper.append("g").attr("id","main"),d3.select(self.frameElement).style("height",this.height+"px")},tree:function(t){this.gTree=t,this.gTree.generation(),this.configContainer(),t.render(this.main)},configContainer:function(){var t=this.gTree.getContainerParameters();this.main.append("rect").attr("class","overlay").attr("width",t.width).attr("height",t.height)},zoom:function(){var t=this;return function(){t.main.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}},calcNewCoordinate:function(t,e,i){var n=t*this.options.focus.scale;n+=e*this.options.focus.scale/2;var o=i/2-n;return o},focusToNode:function(t){var e=this.calcNewCoordinate(t.x,t.width,this.options.container.width),i=this.calcNewCoordinate(t.y,t.height,this.options.container.height);this.focus(e,i)},focus:function(t,e){this.cleanTransform(this.main),this.cleanTransform(this.wrapper);var i="translate("+t+", "+e+")scale("+this.options.focus.scale+")";this.wrapper.attr("transform",i)},cleanTransform:function(t){t.attr("transform",null)}};
//# sourceMappingURL=../maps/all.min.js.map